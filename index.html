<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrambl</title>
    
    <!-- Favicon Support -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Google Analytics -->
    <script>
    // Hide analytics code
    (function() {
        // Create script element for Google Analytics
        var gaScript = document.createElement('script');
        gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-L4YDGSZDV1';
        gaScript.async = true;
        document.head.appendChild(gaScript);
        
        // Initialize Google Analytics
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-L4YDGSZDV1');
    })();
    </script>
    
    <style>
        /* Color variables */
        :root {
            /* Primary colors */
            --primary-dark: #4b4e6d;        /* Dark blue-purple background */
            --primary-mid: #4b4e6d;         /* Same as dark for consistency */
            --primary-light: #95a3b3;       /* Lighter blue-gray background */
            
            /* Accent colors */
            --accent-main: #84dcc6;         /* Teal for main elements */
            --accent-red: #e0777d;          /* Soft red for alerts/timers */
            --accent-peach: #FFDBB5;        /* Peach for success messages and highlights */
            
            /* Text colors */
            --text-light: #ffffff;          /* White text on dark backgrounds */
            --text-dark: #333333;           /* Dark text on light backgrounds */
        }
        
        /* Base styles */
        body {font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif; max-width:600px; margin:0 auto; padding:20px; text-align:center; background-color:var(--primary-light); color:var(--text-dark); line-height:1.5;}
        /* Gradient background to the game container */
        .game-container {
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-mid)); 
            border-radius:16px; 
            padding:24px; 
            box-shadow:0 8px 24px rgba(0,0,0,0.4); 
            transition:all 0.3s ease;
            position: relative; /* For positioning fixed elements */
        }
        
        /* Logo styles */
        .logo-container {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-logo {
            max-width: 200px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); /* Match your text shadow */
            transition: transform 0.3s ease;
        }
        
        .game-logo:hover {
            transform: scale(1.03);
        }
        
        /* Input and buttons */
        input {
            padding:12px 16px; 
            font-size:1.1em; 
            border:none; 
            border-radius:12px; 
            width:65%; 
            margin-right:10px; 
            background-color:var(--primary-light); 
            color:var(--text-dark); 
            box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding:12px 20px; 
            background-color:var(--accent-main); 
            color:var(--text-dark); 
            border:none; 
            border-radius:12px; 
            font-size:1.1em; 
            cursor:pointer; 
            transition:all 0.2s ease; 
            font-weight:600; 
            box-shadow:0 4px 8px rgba(0,0,0,0.2);
            width: 100%; /* Make buttons full width */
            margin-bottom: 10px; /* Add spacing between buttons */
        }
        button:hover {background-color:#70c9b4; transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.2);}
        button:active {transform:translateY(1px); box-shadow:0 2px 4px rgba(0,0,0,0.2);}
        button:focus {outline: 3px solid var(--accent-main); outline-offset: 2px;}
        
        /* FIXED: Style the skip button with red text */
        #skip-btn {
            background-color: white;
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }
        #skip-btn:hover {
            background-color: #ffebee;
        }
        .buttons {margin:24px 0;}
        
        /* Game elements */
        /* Improve scrambled word with letter-spacing, glowing effect and animation */
        .scrambled-word {
            font-size:2.4em; 
            font-weight:bold; 
            margin:28px 0; 
            color:var(--accent-main); 
            letter-spacing:12px; 
            text-shadow:0 0 15px rgba(132, 220, 198, 0.5);
            animation: float 3s ease-in-out infinite;
            padding: 10px;
            background-color: rgba(75, 78, 109, 0.5);
            border-radius: 8px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Animation for new word appearance */
        .scrambled-word.new-word {
            animation: newWord 0.6s ease-out;
        }
        @keyframes newWord {
            0% {transform: scale(0.8); opacity: 0;}
            100% {transform: scale(1); opacity: 1;}
        }
        @keyframes float {
            0% {transform: translateY(0px);}
            50% {transform: translateY(-8px);}
            100% {transform: translateY(0px);}
        }
        #message {margin:20px 0; font-weight:bold; min-height:24px; transition:all 0.3s ease;}
        #message.correct {color:var(--accent-peach); animation:pulse 0.5s;}
        #message.incorrect {color:var(--accent-red); animation:shake 0.5s;}
        /* Shake animation for incorrect answers */
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
        .score {margin-top:20px; font-weight:bold;}
        
        /* Game instructions */
        .start-screen p {
            color: var(--accent-peach);
            font-weight: 500;
        }
        
        /* FIXED: Move timer to top of screen and make it fixed position on mobile */
        .timer-container {
            position: relative;
            width: 100%;
            z-index: 100;
        }
        .timer {
            font-size:1.3em; 
            margin-bottom:15px; 
            color:var(--accent-red); 
            font-weight:bold;
        }
        /* Pulse animation for timer when low */
        .timer.low {animation: timerPulse 1s infinite;}
        @keyframes timerPulse {
            0%, 100% {opacity: 1;}
            50% {opacity: 0.7;}
        }
        
        .game-over, .game-play, .played-today {display:none;}
        .game-over {font-size:1.5em; color:var(--text-light); margin:20px 0;}
        .final-score {font-size:1.5em; color:var(--accent-peach); margin:20px 0;}
        #start-game {background-color:var(--accent-main); font-size:1.3em; padding:16px 32px; letter-spacing:1px;}
        #start-game:hover {background-color:#70c9b4;}
        .start-screen {padding:20px;}
        .countdown {font-size:1.2em; color:var(--accent-red); margin:20px 0;}
        .daily-date {font-size:1.3em; color:var(--accent-main); margin-bottom:10px; font-weight:600;}
	.start-screen p:first-child {
    		margin-top: 0;
    		padding-top: 0;
	}
        .score-display {
            margin:15px 0; 
            font-size:1.3em; 
            font-weight:bold; 
            color:var(--accent-main); 
            background:rgba(75, 78, 109, 0.2); 
            padding:10px; 
            border-radius:12px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        /* Streak display */
        .streak-display {
            margin-top: 10px;
            font-size: 1.1em;
            color: var(--accent-main);
        }
        .share-score {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px; /* Add margin to create space for leaderboard */
        }
        .share-score a {
            display:inline-block; 
            background-color:var(--accent-peach); 
            color:var(--text-dark); 
            padding:12px 24px; 
            border-radius:12px; 
            text-decoration:none; 
            font-size:1.2em; 
            font-weight:600; 
            box-shadow:0 4px 8px rgba(0,0,0,0.2); 
            transition:all 0.2s ease;
        }
        .share-score a:hover {background-color:#f0c9a0; transform:translateY(-2px);}
        /* Share buttons for different platforms */
        .share-score .twitter-share {background-color:var(--accent-peach);}
        .share-score .twitter-share:hover {background-color:#f0c9a0;}
        
        /* Progress bar for timer */
        .timer-progress-container {
            width: 100%;
            height: 8px;
            background-color: #424242;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .timer-progress {
            height: 100%;
            background-color: var(--accent-red);
            width: 100%;
            transition: width 1s linear;
        }
        
        /* Combo system */
        .combo-display {
            font-size: 1.1em;
            color: var(--accent-main);
            margin-top: 5px;
            animation: fadeOut 2s forwards;
            opacity: 0;
        }
        .combo-display.active {
            animation: fadeIn 0.3s forwards;
            opacity: 1;
        }
        @keyframes fadeIn {
            0% {opacity: 0; transform: translateY(10px);}
            100% {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeOut {
            0% {opacity: 1;}
            100% {opacity: 0;}
        }
        
        /* Animations */
        @keyframes pulse {
            0% {transform:scale(1);}
            50% {transform:scale(1.1);}
            100% {transform:scale(1);}
        }
        
        /* Leaderboard styles */
        .leaderboard {
            margin: 15px 0;
            background: rgba(132, 220, 198, 0.2);
            padding: 10px;
            border-radius: 12px;
            max-width: 280px;
            margin: 15px auto;
        }
        
        .leaderboard h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: var(--accent-main);
        }
        
        .leaderboard-entries {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 8px;
            border-radius: 8px;
            background: rgba(75, 78, 109, 0.5);
            color: var(--text-light);
        }
        
        .leaderboard-entry.highlight {
            background: rgba(255, 219, 181, 0.3);
            font-weight: bold;
        }
        
        .leaderboard-entry .rank {
            margin-right: 5px;
        }
        
        .leaderboard-entry .initials {
            font-weight: bold;
            color: var(--accent-main);
        }
        
        .leaderboard-entry .score {
            color: var(--accent-peach);
        }
        
        .leaderboard-empty {
            text-align: center;
            padding: 8px;
            color: #aaa;
            font-style: italic;
        }
        
        /* Initials input */
        .initials-input {
            margin: 15px 0;
        }
        
        .initials-input input {
            text-align: center;
            width: 120px;
            padding: 8px 12px;
            border-radius: 12px;
            background-color: var(--primary-light);
            color: var(--text-dark);
            font-size: 1.1em;
            text-transform: uppercase;
        }
        
        /* FIXED: Mobile responsiveness improvements - especially for when keyboard is open */
        @media (max-width: 480px) {
            body {padding:12px;}
            .game-container {padding:18px; border-radius:12px;}
            
            /* Mobile logo styling */
            .logo-container {
                margin-bottom: 10px;
            }
            
            .game-logo {
                max-width: 150px; /* Smaller on mobile */
            }
            
            .scrambled-word {font-size:2em; letter-spacing:8px; margin-top: 15px; margin-bottom: 15px;}
            
            /* FIXED: Position timer below the score so it's visible when keyboard is open */
            .timer-container {
                position: relative;
                margin-top: 10px;
                padding: 5px;
                z-index: 100;
                background: rgba(75, 78, 109, 0.8);
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            }
            
            .input-area {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                gap: 10px;
            }
            
            input {
                width: 90%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            button {
                width: 90%;
            }
            
            .score-display {font-size:1.1em;}
            .share-score {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
        }
            
        .input-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            width:90%; 
            margin-right: 0;
            margin-bottom: 10px;
        }
        
        button {
            padding:10px 16px;
            width: 80%;
        }
        
        /* FIXED: Make the skip button float at bottom */
        .buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-dark);
            padding: 10px;
            margin: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        /* FIXED: Make timer more visible */
        .timer {
            font-size: 1.5em;
            padding: 8px;
            margin: 0;
        }
        
        /* FIXED: Make progress bar more visible */
        .timer-progress-container {
            height: 10px;
            margin-bottom: 5px;
            width: 90%;
        }
        
        .score-display {
            font-size:1.1em;
        }
        
        .share-score {
            flex-direction: column;
            align-items: center;
            gap: 10px;

        }
        
        /* Add these styles to your existing CSS */
        .stats-display {
            margin: 15px auto;
            padding: 10px;
            background: rgba(132, 220, 198, 0.2);
            border-radius: 12px;
            max-width: 280px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(75, 78, 109, 0.5);
            border-radius: 8px;
            color: var(--text-light);
        }
        
        .stat-label {
            font-weight: bold;
            color: var(--accent-main);
        }
        
        .stat-value {
            color: var(--accent-peach);
        }
        
        /* Add these styles to your existing CSS */
        .verification-step {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .verification-step input {
            width: 90%;
            text-align: center;
            font-size: 1.1em;
            padding: 12px;
            border: 2px solid var(--accent-main);
            border-radius: 12px;
            background-color: var(--primary-light);
            color: var(--text-dark);
        }
        
        .verification-step input:focus {
            outline: none;
            border-color: var(--accent-peach);
            box-shadow: 0 0 0 3px rgba(255, 219, 181, 0.3);
        }
        
        .verify-btn {
            width: auto !important;
            padding: 10px 20px;
            background-color: var(--accent-main);
            color: var(--text-dark);
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .verify-btn:disabled {
            background-color: var(--primary-light);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .verify-btn:hover:not(:disabled) {
            background-color: #70c9b4;
            transform: translateY(-2px);
        }
        
        #recaptcha-container {
            margin: 10px 0;
        }
        
        /* Mobile responsiveness for verification steps */
        @media (max-width: 480px) {
            .verification-step input {
                width: 95%;
                font-size: 1em;
                padding: 10px;
            }
            
            .verify-btn {
                width: 95% !important;
                font-size: 1em;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Replaced h1 with logo image -->
        <div class="logo-container">
            <img src="scrambl-logo.png" alt="Scrambl" class="game-logo">
        </div>
        <div class="daily-date" id="daily-date"></div>

        <div class="start-screen" id="start-screen">
            <p>a new scrambl every day</p>
            <p>solve the most words in 30 seconds</p>
            <p>10 points for each letter in a word</p>
            
            <!-- Phone verification container -->
            <div id="phone-input-container" class="verification-step">
                <input type="tel" id="player-phone" placeholder="Enter your phone number" maxlength="10" pattern="[0-9]{10}">
                <div id="recaptcha-container"></div>
                <button id="verify-phone" class="verify-btn" disabled>Send Verification Code</button>
            </div>
            
            <!-- Verification code container -->
            <div id="verification-container" class="verification-step" style="display: none;">
                <input type="text" id="verification-code" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                <button id="submit-verification" class="verify-btn">Verify Code</button>
            </div>
            
            <!-- Username container -->
            <div id="username-container" class="verification-step" style="display: none;">
                <input type="text" id="player-username" placeholder="Choose a username (3-15 characters)" maxlength="15" autocomplete="off">
                <button id="set-username" class="verify-btn">Set Username</button>
            </div>
            
            <!-- Leaderboard display -->
            <div class="leaderboard" id="leaderboard">
                <h3>today's top scores</h3>
                <div class="leaderboard-entries" id="leaderboard-entries">
                    <div class="leaderboard-empty">Play to get on the board</div>
                </div>
            </div>
            
            <!-- Streak display -->
            <div class="streak-display" id="streak-display"></div>
            
            <button id="start-game" role="button" aria-label="Start game" disabled>Play</button>
        </div>

        <div class="played-today" id="played-today">
    <p>Already played today.</p>
    <div class="final-score">Score: <span id="today-score">0</span></div>
    <div class="streak-display" id="current-streak-display"></div>
    <div class="countdown" id="countdown"></div>
    
    <!-- Added stats display -->
    <div class="stats-display">
        <div class="stat-item">
            <span class="stat-label">Most Solved:</span>
            <span class="stat-value" id="most-solved-word-played">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Most Skipped:</span>
            <span class="stat-value" id="most-skipped-word-played">-</span>
        </div>
    </div>
    
    <!-- Added leaderboard to played-today screen - MOVED ABOVE SHARE BUTTONS -->
    <div class="leaderboard" id="played-today-leaderboard">
        <h3>today's top scores</h3>
        <div class="leaderboard-entries" id="played-today-leaderboard-entries">
            <div class="leaderboard-empty">Be the first to rank!</div>
        </div>
    </div>
    
    <!-- Share buttons now below leaderboard -->
    <div class="share-score">
        <a id="share-link-played" href="#" target="_blank" aria-label="Share via SMS">Share on SMS</a>
        <a id="twitter-share-played" href="#" target="_blank" class="twitter-share" aria-label="Share on Twitter/X">Share on Twitter/X</a>
    </div>
</div>

        <div class="game-play" id="game-play">
            <div class="score-display">
                <div>Words: <span id="words-solved">0</span></div>
                <div>Score: <span id="score">0</span></div>
            </div>
            
            <!-- FIXED: Moved timer below score display for better visibility on mobile -->
            <div class="timer-container">
                <div class="timer-progress-container">
                    <div class="timer-progress" id="timer-progress"></div>
                </div>
                <div class="timer" id="timer">Time: 30s</div>
            </div>
            
            <!-- Combo display -->
            <div class="combo-display" id="combo-display"></div>
            
            <div class="scrambled-word" id="scrambled-word" aria-live="polite">RDOW</div>
            
            <div class="input-area">
                <input type="text" id="user-guess" placeholder="Enter your answer" autocomplete="off" aria-label="Your answer">
                <button id="submit-btn" aria-label="Submit answer">Submit</button>
                <!-- FIXED: Moved skip button directly below submit button -->
                <button id="skip-btn" aria-label="Skip this word">Skip</button>
            </div>
            
            <!-- Removed the separate buttons div since skip is now in the input-area -->
            
            <div id="message" aria-live="assertive"></div>
        </div>

        <div class="game-over" id="game-over">
    <p>Game Over</p>
    <div class="final-score" id="final-score-display"></div>
    
    <!-- Added stats display -->
    <div class="stats-display">
        <div class="stat-item">
            <span class="stat-label">Most Solved:</span>
            <span class="stat-value" id="most-solved-word">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Most Skipped:</span>
            <span class="stat-value" id="most-skipped-word">-</span>
        </div>
    </div>
    
    <!-- Added leaderboard to game over screen - MOVED ABOVE SHARE BUTTONS -->
    <div class="leaderboard" id="game-over-leaderboard">
        <h3>today's top scores</h3>
        <div class="leaderboard-entries" id="game-over-leaderboard-entries">
            <div class="leaderboard-empty">Be the first to rank!</div>
        </div>
    </div>
    
    <!-- Share buttons now below leaderboard -->
    <div class="share-score">
        <a id="share-link" href="#" target="_blank" aria-label="Share via SMS">Share on SMS</a>
        <a id="twitter-share" href="#" target="_blank" class="twitter-share" aria-label="Share on Twitter/X">Share on Twitter/X</a>
    </div>
    
    <!-- Added streak display to game over screen -->
    <div class="streak-display" id="game-over-streak-display"></div>
    <div class="countdown" id="countdown-end"></div>
</div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1sNTFNxF15_kIhxUplaq5EPasYOi_Bzs",
            authDomain: "scrambl-1cc67.firebaseapp.com",
            databaseURL: "https://scrambl-1cc67-default-rtdb.firebaseio.com",
            projectId: "scrambl-1cc67",
            storageBucket: "scrambl-1cc67.firebasestorage.app",
            messagingSenderId: "589881408440",
            appId: "1:589881408440:web:d8e3906bc040dd9a9bed4d",
            measurementId: "G-XRCMRNC90E"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        // Game module pattern
        const ScramblGame = (function() {
            // Make Firebase services accessible in the game module
            const firebaseDB = database;
            const firebaseAuth = auth;
            
            // Add new variables for user profile
            let userProfile = {
                phoneNumber: null,
                username: null,
                verified: false
            };
            
            // Cache DOM elements
            const elements = {
                startScreen: document.getElementById("start-screen"),
                playedToday: document.getElementById("played-today"),
                gamePlay: document.getElementById("game-play"),
                gameOver: document.getElementById("game-over"),
                startButton: document.getElementById("start-game"),
                scrambledWord: document.getElementById("scrambled-word"),
                userGuess: document.getElementById("user-guess"),
                submitBtn: document.getElementById("submit-btn"),
                skipBtn: document.getElementById("skip-btn"),
                message: document.getElementById("message"),
                score: document.getElementById("score"),
                timer: document.getElementById("timer"),
                timerProgress: document.getElementById("timer-progress"),
                wordsSolved: document.getElementById("words-solved"),
                countdown: document.getElementById("countdown"),
                countdownEnd: document.getElementById("countdown-end"),
                todayScore: document.getElementById("today-score"),
                dailyDate: document.getElementById("daily-date"),
                shareLink: document.getElementById("share-link"),
                shareLinkPlayed: document.getElementById("share-link-played"),
                twitterShare: document.getElementById("twitter-share"),
                twitterSharePlayed: document.getElementById("twitter-share-played"),
                streakDisplay: document.getElementById("streak-display"),
                currentStreakDisplay: document.getElementById("current-streak-display"),
                gameOverStreakDisplay: document.getElementById("game-over-streak-display"),
                playerInitialsInput: document.getElementById("player-initials"),
                leaderboardEntries: document.getElementById("leaderboard-entries"),
                gameOverLeaderboardEntries: document.getElementById("game-over-leaderboard-entries"),
		playedTodayLeaderboardEntries: document.getElementById("played-today-leaderboard-entries"),
                comboDisplay: document.getElementById("combo-display"),
                playerPhoneInput: document.getElementById("player-phone"),
                verifyPhoneBtn: document.getElementById("verify-phone"),
                verificationCodeInput: document.getElementById("verification-code"),
                submitVerificationBtn: document.getElementById("submit-verification"),
                playerUsernameInput: document.getElementById("player-username"),
                verificationContainer: document.getElementById("verification-container"),
                phoneInputContainer: document.getElementById("phone-input-container"),
                usernameContainer: document.getElementById("username-container")
            };
            
            // Initialize reCAPTCHA
            let recaptchaVerifier;
            function initRecaptcha() {
                if (!recaptchaVerifier) {
                    recaptchaVerifier = new RecaptchaVerifier(firebaseAuth, 'recaptcha-container', {
                        'size': 'invisible',
                        'callback': (response) => {
                            // reCAPTCHA solved, enable phone verification
                            elements.verifyPhoneBtn.disabled = false;
                        },
                        'expired-callback': () => {
                            elements.verifyPhoneBtn.disabled = true;
                            showMessage('reCAPTCHA expired. Please reload the page.', 'incorrect');
                        }
                    });
                    recaptchaVerifier.render(); // Ensure reCAPTCHA is rendered
                    window.recaptchaVerifier = recaptchaVerifier; // Expose globally for debugging
                }
            }
            
            // Phone verification functions
            async function sendVerificationCode() {
                const phoneNumber = elements.playerPhoneInput.value;
                if (!phoneNumber || phoneNumber.length !== 10) {
                    showMessage("Please enter a valid 10-digit phone number", "incorrect");
                    return;
                }
                
                try {
                    const formattedPhone = `+1${phoneNumber}`; // Assuming US numbers
                    console.log('formattedPhone:', formattedPhone);
                    console.log('recaptchaVerifier:', recaptchaVerifier);
                    if (recaptchaVerifier) {
                        await recaptchaVerifier.render();
                        console.log('recaptchaVerifier rendered');
                    } else {
                        showMessage("reCAPTCHA not initialized. Please reload the page.", "incorrect");
                        return;
                    }
                    console.log('About to call signInWithPhoneNumber');
                    const confirmationResult = await signInWithPhoneNumber(firebaseAuth, formattedPhone, recaptchaVerifier);
                    console.log('signInWithPhoneNumber resolved', confirmationResult);
                    window.confirmationResult = confirmationResult;
                    
                    // Show verification code input
                    elements.phoneInputContainer.style.display = 'none';
                    elements.verificationContainer.style.display = 'block';
                    showMessage("Verification code sent!", "correct");
                    console.log('UI updated to show verification code input');
                } catch (error) {
                    console.error("Error sending verification code:", error);
                    showMessage("Error sending verification code: " + error.message, "incorrect");
                }
            }
            
            async function verifyCode() {
                const code = elements.verificationCodeInput.value;
                if (!code || code.length !== 6) {
                    showMessage("Please enter the 6-digit verification code", "incorrect");
                    return;
                }
                
                try {
                    const result = await window.confirmationResult.confirm(code);
                    userProfile.phoneNumber = result.user.phoneNumber;
                    userProfile.verified = true;
                    
                    // Save phone number to Firebase
                    const userRef = ref(firebaseDB, `users/${result.user.uid}`);
                    await set(userRef, {
                        phoneNumber: userProfile.phoneNumber,
                        lastLogin: Date.now()
                    });
                    
                    // Show username input
                    elements.verificationContainer.style.display = 'none';
                    elements.usernameContainer.style.display = 'block';
                    showMessage("Phone verified! Choose a username", "correct");
                } catch (error) {
                    console.error("Error verifying code:", error);
                    showMessage("Invalid verification code. Please try again.", "incorrect");
                }
            }
            
            // Username validation
            async function validateUsername(username) {
                if (!username || username.length < 3 || username.length > 15) {
                    return false;
                }
                
                // Check if username is available
                const usernameRef = ref(firebaseDB, `usernames/${username}`);
                const snapshot = await get(usernameRef);
                return !snapshot.exists();
            }
            
            async function setUsername() {
                const username = elements.playerUsernameInput.value.trim();
                if (!await validateUsername(username)) {
                    showMessage("Username is taken or invalid (3-15 characters)", "incorrect");
                    return;
                }
                
                try {
                    // Save username to Firebase
                    const userRef = ref(firebaseDB, `users/${firebaseAuth.currentUser.uid}`);
                    await set(userRef, {
                        ...userProfile,
                        username: username,
                        lastLogin: Date.now()
                    });
                    
                    // Reserve username
                    const usernameRef = ref(firebaseDB, `usernames/${username}`);
                    await set(usernameRef, {
                        uid: firebaseAuth.currentUser.uid,
                        timestamp: Date.now()
                    });
                    
                    userProfile.username = username;
                    showMessage("Username set! Ready to play!", "correct");
                    
                    // Enable start game button
                    elements.startButton.disabled = false;
                } catch (error) {
                    console.error("Error setting username:", error);
                    showMessage("Error setting username. Please try again.", "incorrect");
                }
            }
            
            // Helper function for messages
            function showMessage(text, className) {
                elements.message.textContent = text;
                elements.message.className = className;
            }
            
            // Modify startGame function
            function startGame() {
                if (hasPlayedToday()) return;
                if (!userProfile.verified || !userProfile.username) {
                    showMessage("Please complete verification first", "incorrect");
                    return;
                }
                
                // Get player initials
                playerInitials = elements.playerInitialsInput.value.trim().toUpperCase().substring(0, 3);
                localStorage.setItem('lastInitials', playerInitials);
                
                // Reset game variables
                currentWordIndex = 0;
                score = 0;
                wordsSolved = 0;
                timeLeft = GAME_TIME;
                gameActive = true;
                currentStreak = 0;
                comboMultiplier = 1;
                lastSolveTime = Date.now();

                elements.score.textContent = score;
                elements.wordsSolved.textContent = wordsSolved;
                updateTimer();

                elements.startScreen.style.display = "none";
                elements.gamePlay.style.display = "block";
                elements.gameOver.style.display = "none";

                getNextWord();
            }
            
            // Add event listeners
            elements.verifyPhoneBtn.addEventListener("click", sendVerificationCode);
            elements.submitVerificationBtn.addEventListener("click", verifyCode);
            elements.playerUsernameInput.addEventListener("input", function() {
                this.value = this.value.replace(/[^a-zA-Z0-9_]/g, '');
            });
            // Enable the verify button when phone number is valid
            elements.playerPhoneInput.addEventListener('input', function() {
                const phone = this.value.replace(/[^0-9]/g, '');
                this.value = phone;
                elements.verifyPhoneBtn.disabled = phone.length !== 10;
            });
            
            // Initialize game
            function initGame() {
                initRecaptcha(); // Ensure reCAPTCHA is initialized on page load
                const timestamp = new Date().getTime();
                today = getCurrentDateCT() + "?t=" + timestamp;
                
                const now = new Date();
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                elements.dailyDate.textContent = now.toLocaleDateString('en-US', options);

                const lastPlayedDate = localStorage.getItem('lastPlayedDate');
                if (lastPlayedDate && lastPlayedDate.split("?")[0] !== today.split("?")[0]) {
                    localStorage.removeItem('lastPlayedDate');
                    localStorage.removeItem('lastScore');
                    localStorage.removeItem('wordsSolved');
                    // Don't remove lastInitials so we can remember the player
                }
                
                dailyWords = getDailyWords(today.split("?")[0]);
                
                // Update streak display
                updateStreakDisplay();
                
                // Load leaderboard from Firebase
                loadLeaderboard();
                
                // Set previous initials if available
                const lastInitials = localStorage.getItem('lastInitials');
                if (lastInitials) {
                    elements.playerInitialsInput.value = lastInitials;
                    playerInitials = lastInitials;
                }
                
                // Track page view
                analytics.trackPageView();

                if (hasPlayedToday()) {
                    try {
                        const lastScore = localStorage.getItem('lastScore') || "0";
                        const lastWordsSolved = localStorage.getItem('wordsSolved') || "0";
                        elements.todayScore.textContent = `${lastWordsSolved} words | ${lastScore} points`;
                        
                        setupShareLink("share-link-played");
                    } catch (error) {
                        console.error("Local storage error:", error);
                    }

                    elements.startScreen.style.display = "none";
                    elements.playedToday.style.display = "block";
                    updateCountdown();
                    setInterval(updateCountdown, 60000);
                } else {
                    elements.startScreen.style.display = "block";
                    elements.playedToday.style.display = "none";
                }

                // Load word stats
                getMostStats();
                
                // Check for existing user session
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // User is signed in
                        const userRef = ref(firebaseDB, `users/${user.uid}`);
                        const snapshot = await get(userRef);
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            userProfile = {
                                phoneNumber: userData.phoneNumber,
                                username: userData.username,
                                verified: true
                            };
                            
                            // Show game start screen
                            elements.phoneInputContainer.style.display = 'none';
                            elements.verificationContainer.style.display = 'none';
                            elements.usernameContainer.style.display = 'none';
                            elements.startScreen.style.display = 'block';
                        }
                    } else {
                        // User is not signed in
                        elements.phoneInputContainer.style.display = 'block';
                        elements.verificationContainer.style.display = 'none';
                        elements.usernameContainer.style.display = 'none';
                        elements.startScreen.style.display = 'none';
                    }
                });
            }
            
            // ... rest of existing code ...
        })();
    </script>
</body>
</html>
