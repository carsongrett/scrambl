<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrambl</title>
    
    <!-- Favicon Support -->
    <link rel="icon" href="favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Google Analytics -->
    <script>
    // Hide analytics code
    (function() {
        // Create script element for Google Analytics
        var gaScript = document.createElement('script');
        gaScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-L4YDGSZDV1';
        gaScript.async = true;
        document.head.appendChild(gaScript);
        
        // Initialize Google Analytics
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-L4YDGSZDV1');
    })();
    </script>
    
    <style>
        /* Color variables */
        :root {
            /* Primary colors */
            --primary-dark: #4b4e6d;        /* Dark blue-purple background */
            --primary-mid: #4b4e6d;         /* Same as dark for consistency */
            --primary-light: #95a3b3;       /* Lighter blue-gray background */
            
            /* Accent colors */
            --accent-main: #84dcc6;         /* Teal for main elements */
            --accent-red: #e0777d;          /* Soft red for alerts/timers */
            --accent-peach: #FFDBB5;        /* Peach for success messages and highlights */
            
            /* Text colors */
            --text-light: #ffffff;          /* White text on dark backgrounds */
            --text-dark: #333333;           /* Dark text on light backgrounds */
        }
        
        /* Base styles */
        body {font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif; max-width:600px; margin:0 auto; padding:20px; text-align:center; background-color:var(--primary-light); color:var(--text-dark); line-height:1.5;}
        /* Gradient background to the game container */
        .game-container {
            background: linear-gradient(145deg, var(--primary-dark), var(--primary-mid)); 
            border-radius:16px; 
            padding:24px; 
            box-shadow:0 8px 24px rgba(0,0,0,0.4); 
            transition:all 0.3s ease;
            position: relative; /* For positioning fixed elements */
        }
        
        /* Logo styles */
        .logo-container {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .game-logo {
            max-width: 200px;
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); /* Match your text shadow */
            transition: transform 0.3s ease;
        }
        
        .game-logo:hover {
            transform: scale(1.03);
        }
        
        /* Input and buttons */
        input {
            padding:12px 16px; 
            font-size:1.1em; 
            border:none; 
            border-radius:12px; 
            width:65%; 
            margin-right:10px; 
            background-color:var(--primary-light); 
            color:var(--text-dark); 
            box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding:12px 20px; 
            background-color:var(--accent-main); 
            color:var(--text-dark); 
            border:none; 
            border-radius:12px; 
            font-size:1.1em; 
            cursor:pointer; 
            transition:all 0.2s ease; 
            font-weight:600; 
            box-shadow:0 4px 8px rgba(0,0,0,0.2);
            width: 100%; /* Make buttons full width */
            margin-bottom: 10px; /* Add spacing between buttons */
        }
        button:hover {background-color:#70c9b4; transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.2);}
        button:active {transform:translateY(1px); box-shadow:0 2px 4px rgba(0,0,0,0.2);}
        button:focus {outline: 3px solid var(--accent-main); outline-offset: 2px;}
        
        /* FIXED: Style the skip button with red text */
        #skip-btn {
            background-color: white;
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }
        #skip-btn:hover {
            background-color: #ffebee;
        }
        .buttons {margin:24px 0;}
        
        /* Game elements */
        /* Improve scrambled word with letter-spacing, glowing effect and animation */
        .scrambled-word {
            font-size:2.4em; 
            font-weight:bold; 
            margin:28px 0; 
            color:var(--accent-main); 
            letter-spacing:12px; 
            text-shadow:0 0 15px rgba(132, 220, 198, 0.5);
            animation: float 3s ease-in-out infinite;
            padding: 10px;
            background-color: rgba(75, 78, 109, 0.5);
            border-radius: 8px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* Animation for new word appearance */
        .scrambled-word.new-word {
            animation: newWord 0.6s ease-out;
        }
        @keyframes newWord {
            0% {transform: scale(0.8); opacity: 0;}
            100% {transform: scale(1); opacity: 1;}
        }
        @keyframes float {
            0% {transform: translateY(0px);}
            50% {transform: translateY(-8px);}
            100% {transform: translateY(0px);}
        }
        #message {margin:20px 0; font-weight:bold; min-height:24px; transition:all 0.3s ease;}
        #message.correct {color:var(--accent-peach); animation:pulse 0.5s;}
        #message.incorrect {color:var(--accent-red); animation:shake 0.5s;}
        /* Shake animation for incorrect answers */
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-5px);}
            40%, 80% {transform: translateX(5px);}
        }
        .score {margin-top:20px; font-weight:bold;}
        
        /* Game instructions */
        .start-screen p {
            color: var(--accent-peach);
            font-weight: 500;
        }
        
        /* FIXED: Move timer to top of screen and make it fixed position on mobile */
        .timer-container {
            position: relative;
            width: 100%;
            z-index: 100;
        }
        .timer {
            font-size:1.3em; 
            margin-bottom:15px; 
            color:var(--accent-red); 
            font-weight:bold;
        }
        /* Pulse animation for timer when low */
        .timer.low {animation: timerPulse 1s infinite;}
        @keyframes timerPulse {
            0%, 100% {opacity: 1;}
            50% {opacity: 0.7;}
        }
        
        .game-over, .game-play, .played-today {display:none;}
        .game-over {font-size:1.5em; color:var(--text-light); margin:20px 0;}
        .final-score {font-size:1.5em; color:var(--accent-peach); margin:20px 0;}
        #start-game {background-color:var(--accent-main); font-size:1.3em; padding:16px 32px; letter-spacing:1px;}
        #start-game:hover {background-color:#70c9b4;}
        .start-screen {padding:20px;}
        .countdown {font-size:1.2em; color:var(--accent-red); margin:20px 0;}
        .daily-date {font-size:1.3em; color:var(--accent-main); margin-bottom:10px; font-weight:600;}
	.start-screen p:first-child {
    		margin-top: 0;
    		padding-top: 0;
	}
        .score-display {
            margin:15px 0; 
            font-size:1.3em; 
            font-weight:bold; 
            color:var(--accent-main); 
            background:rgba(75, 78, 109, 0.2); 
            padding:10px; 
            border-radius:12px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        /* Streak display */
        .streak-display {
            margin-top: 10px;
            font-size: 1.1em;
            color: var(--accent-main);
        }
        .share-score {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            margin-bottom: 20px; /* Add margin to create space for leaderboard */
        }
        .share-score a {
            display:inline-block; 
            background-color:var(--accent-peach); 
            color:var(--text-dark); 
            padding:12px 24px; 
            border-radius:12px; 
            text-decoration:none; 
            font-size:1.2em; 
            font-weight:600; 
            box-shadow:0 4px 8px rgba(0,0,0,0.2); 
            transition:all 0.2s ease;
        }
        .share-score a:hover {background-color:#f0c9a0; transform:translateY(-2px);}
        /* Share buttons for different platforms */
        .share-score .twitter-share {background-color:var(--accent-peach);}
        .share-score .twitter-share:hover {background-color:#f0c9a0;}
        
        /* Progress bar for timer */
        .timer-progress-container {
            width: 100%;
            height: 8px;
            background-color: #424242;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .timer-progress {
            height: 100%;
            background-color: var(--accent-red);
            width: 100%;
            transition: width 1s linear;
        }
        
        /* Combo system */
        .combo-display {
            font-size: 1.1em;
            color: var(--accent-main);
            margin-top: 5px;
            animation: fadeOut 2s forwards;
            opacity: 0;
        }
        .combo-display.active {
            animation: fadeIn 0.3s forwards;
            opacity: 1;
        }
        @keyframes fadeIn {
            0% {opacity: 0; transform: translateY(10px);}
            100% {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeOut {
            0% {opacity: 1;}
            100% {opacity: 0;}
        }
        
        /* Animations */
        @keyframes pulse {
            0% {transform:scale(1);}
            50% {transform:scale(1.1);}
            100% {transform:scale(1);}
        }
        
        /* Leaderboard styles */
        .leaderboard {
            margin: 15px 0;
            background: rgba(132, 220, 198, 0.2);
            padding: 10px;
            border-radius: 12px;
            max-width: 280px;
            margin: 15px auto;
        }
        
        .leaderboard h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: var(--accent-main);
        }
        
        .leaderboard-entries {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 8px;
            border-radius: 8px;
            background: rgba(75, 78, 109, 0.5);
            color: var(--text-light);
        }
        
        .leaderboard-entry.highlight {
            background: rgba(255, 219, 181, 0.3);
            font-weight: bold;
        }
        
        .leaderboard-entry .rank {
            margin-right: 5px;
        }
        
        .leaderboard-entry .initials {
            font-weight: bold;
            color: var(--accent-main);
        }
        
        .leaderboard-entry .score {
            color: var(--accent-peach);
        }
        
        .leaderboard-empty {
            text-align: center;
            padding: 8px;
            color: #aaa;
            font-style: italic;
        }
        
        /* Initials input */
        .initials-input {
            margin: 15px 0;
        }
        
        .initials-input input {
            text-align: center;
            width: 120px;
            padding: 8px 12px;
            border-radius: 12px;
            background-color: var(--primary-light);
            color: var(--text-dark);
            font-size: 1.1em;
            text-transform: uppercase;
        }
        
        /* FIXED: Mobile responsiveness improvements - especially for when keyboard is open */
        @media (max-width: 480px) {
            body {padding:12px;}
            .game-container {padding:18px; border-radius:12px;}
            
            /* Mobile logo styling */
            .logo-container {
                margin-bottom: 10px;
            }
            
            .game-logo {
                max-width: 150px; /* Smaller on mobile */
            }
            
            .scrambled-word {font-size:2em; letter-spacing:8px; margin-top: 15px; margin-bottom: 15px;}
            
            /* FIXED: Position timer below the score so it's visible when keyboard is open */
            .timer-container {
                position: relative;
                margin-top: 10px;
                padding: 5px;
                z-index: 100;
                background: rgba(75, 78, 109, 0.8);
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            }
            
            .input-area {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                gap: 10px;
            }
            
            input {
                width: 90%;
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            button {
                width: 90%;
            }
            
            .score-display {font-size:1.1em;}
            .share-score {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
        }
            
        .input-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            width:90%; 
            margin-right: 0;
            margin-bottom: 10px;
        }
        
        button {
            padding:10px 16px;
            width: 80%;
        }
        
        /* FIXED: Make the skip button float at bottom */
        .buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-dark);
            padding: 10px;
            margin: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        
        /* FIXED: Make timer more visible */
        .timer {
            font-size: 1.5em;
            padding: 8px;
            margin: 0;
        }
        
        /* FIXED: Make progress bar more visible */
        .timer-progress-container {
            height: 10px;
            margin-bottom: 5px;
            width: 90%;
        }
        
        .score-display {
            font-size:1.1em;
        }
        
        .share-score {
            flex-direction: column;
            align-items: center;
            gap: 10px;

        }
        
        /* Add these styles to your existing CSS */
        .stats-display {
            margin: 15px auto;
            padding: 10px;
            background: rgba(132, 220, 198, 0.2);
            border-radius: 12px;
            max-width: 280px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(75, 78, 109, 0.5);
            border-radius: 8px;
            color: var(--text-light);
        }
        
        .stat-label {
            font-weight: bold;
            color: var(--accent-main);
        }
        
        .stat-value {
            color: var(--accent-peach);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Replaced h1 with logo image -->
        <div class="logo-container">
            <img src="scrambl-logo.png" alt="Scrambl" class="game-logo">
        </div>
        <div class="daily-date" id="daily-date"></div>

        <div class="start-screen" id="start-screen">
            <p>a new scrambl every day</p>
            <p>solve the most words in 30 seconds</p>
            <p>10 points for each letter in a word</p>
            
            <!-- Added initials input -->
            <div class="initials-input">
                <input type="text" id="player-initials" placeholder="Initials" maxlength="3" autocomplete="off">
            </div>
            
            <!-- Leaderboard display -->
            <div class="leaderboard" id="leaderboard">
                <h3>today's top scores</h3>
                <div class="leaderboard-entries" id="leaderboard-entries">
                    <div class="leaderboard-empty">Play to get on the board</div>
                </div>
            </div>
            
            <!-- Streak display -->
            <div class="streak-display" id="streak-display"></div>
            
            <button id="start-game" role="button" aria-label="Start game">Play</button>
        </div>

        <div class="played-today" id="played-today">
    <p>Already played today.</p>
    <div class="final-score">Score: <span id="today-score">0</span></div>
    <div class="streak-display" id="current-streak-display"></div>
    <div class="countdown" id="countdown"></div>
    
    <!-- Added stats display -->
    <div class="stats-display">
        <div class="stat-item">
            <span class="stat-label">Most Solved:</span>
            <span class="stat-value" id="most-solved-word-played">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Most Skipped:</span>
            <span class="stat-value" id="most-skipped-word-played">-</span>
        </div>
    </div>
    
    <!-- Added leaderboard to played-today screen - MOVED ABOVE SHARE BUTTONS -->
    <div class="leaderboard" id="played-today-leaderboard">
        <h3>today's top scores</h3>
        <div class="leaderboard-entries" id="played-today-leaderboard-entries">
            <div class="leaderboard-empty">Be the first to rank!</div>
        </div>
    </div>
    
    <!-- Share buttons now below leaderboard -->
    <div class="share-score">
        <a id="share-link-played" href="#" target="_blank" aria-label="Share via SMS">Share on SMS</a>
        <a id="twitter-share-played" href="#" target="_blank" class="twitter-share" aria-label="Share on Twitter/X">Share on Twitter/X</a>
    </div>
</div>

        <div class="game-play" id="game-play">
            <div class="score-display">
                <div>Words: <span id="words-solved">0</span></div>
                <div>Score: <span id="score">0</span></div>
            </div>
            
            <!-- FIXED: Moved timer below score display for better visibility on mobile -->
            <div class="timer-container">
                <div class="timer-progress-container">
                    <div class="timer-progress" id="timer-progress"></div>
                </div>
                <div class="timer" id="timer">Time: 30s</div>
            </div>
            
            <!-- Combo display -->
            <div class="combo-display" id="combo-display"></div>
            
            <div class="scrambled-word" id="scrambled-word" aria-live="polite">RDOW</div>
            
            <div class="input-area">
                <input type="text" id="user-guess" placeholder="Enter your answer" autocomplete="off" aria-label="Your answer">
                <button id="submit-btn" aria-label="Submit answer">Submit</button>
                <!-- FIXED: Moved skip button directly below submit button -->
                <button id="skip-btn" aria-label="Skip this word">Skip</button>
            </div>
            
            <!-- Removed the separate buttons div since skip is now in the input-area -->
            
            <div id="message" aria-live="assertive"></div>
        </div>

        <div class="game-over" id="game-over">
    <p>Game Over</p>
    <div class="final-score" id="final-score-display"></div>
    
    <!-- Added stats display -->
    <div class="stats-display">
        <div class="stat-item">
            <span class="stat-label">Most Solved:</span>
            <span class="stat-value" id="most-solved-word">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Most Skipped:</span>
            <span class="stat-value" id="most-skipped-word">-</span>
        </div>
    </div>
    
    <!-- Added leaderboard to game over screen - MOVED ABOVE SHARE BUTTONS -->
    <div class="leaderboard" id="game-over-leaderboard">
        <h3>today's top scores</h3>
        <div class="leaderboard-entries" id="game-over-leaderboard-entries">
            <div class="leaderboard-empty">Be the first to rank!</div>
        </div>
    </div>
    
    <!-- Share buttons now below leaderboard -->
    <div class="share-score">
        <a id="share-link" href="#" target="_blank" aria-label="Share via SMS">Share on SMS</a>
        <a id="twitter-share" href="#" target="_blank" class="twitter-share" aria-label="Share on Twitter/X">Share on Twitter/X</a>
    </div>
    
    <!-- Added streak display to game over screen -->
    <div class="streak-display" id="game-over-streak-display"></div>
    <div class="countdown" id="countdown-end"></div>
</div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, push, query, orderByChild, limitToLast, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1sNTFNxF15_kIhxUplaq5EPasYOi_Bzs",
            authDomain: "scrambl-1cc67.firebaseapp.com",
            databaseURL: "https://scrambl-1cc67-default-rtdb.firebaseio.com",
            projectId: "scrambl-1cc67",
            storageBucket: "scrambl-1cc67.firebasestorage.app",
            messagingSenderId: "589881408440",
            appId: "1:589881408440:web:d8e3906bc040dd9a9bed4d",
            measurementId: "G-XRCMRNC90E"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        
        // Game module pattern
        const ScramblGame = (function() {
            // Make Firebase services accessible in the game module
            const firebaseDB = database;
            
            // Analytics module
            const analytics = {
                trackPageView: function() {
                    gtag('event', 'Scrambl_Page_Visit', {
                        'page_title': 'Scrambl Word Game',
                        'page_location': window.location.href
                    });
                },
                
                trackGameCompleted: function(score, wordsSolved, difficulty) {
                    gtag('event', 'Scrambl_Game_Completed', {
                        'event_category': 'Game Actions',
                        'score': score,
                        'words_solved': wordsSolved,
                        'difficulty': difficulty
                    });
                },
                
                trackShare: function(context, score, platform) {
                    gtag('event', 'Scrambl_Score_Shared', {
                        'event_category': 'Game Actions',
                        'share_context': context,
                        'score': score,
                        'platform': platform
                    });
                },
            };

            // Word list - simplified to array initialization
            const allWords = [
                // 50 three-letter words
                "ACE", "BAG", "BEE", "BOX", "BUG", "BUS", "CAP", "COW", "CUP", "EGG","EYE", "FAN", "FIN", "FLY", "FOX", "FUN", "GEM", "HEN", "ICE", "JOY", "KEY", 
"KID", "LEG", "LIP", "MUD", "OWL", "PEN", "PIE", 
"RUG", "SKY", "SUN", "TOE", "VAN", "WEB", "ZOO",

                
                // 50 four-letter words
                "ABLE", "BABY", "BALL", "BEAR", "BELT", "BIKE", "BIRD", "BOAT", "BOOK", "BOWL", "CAKE", "CARD", "CASH", "CHEF", "COIN", "COOL", "DART", "DESK", "DISH", "DOOR", 
"DRUM", "DUCK", "FISH", "FLAG", "FROG", "GAME", "GIFT", "GOLD", "HAIR", "HAND", 
"HERO", "HOOK", "JUMP", "KITE", "LAMP", "LEAF", "MASK", "MOON", "NAIL", "PARK", 
"PLUG", "RAIN", "RING", "ROCK", "ROPE", "SHIP", "SHOE", "TIRE", "TREE",

                
                // 50 five-letter words
                "APPLE", "BEACH", "BREAD", "BRICK", "BRUSH", "CHAIR", "CHEESE", "CLOCK", "CLOUD", "DANCE", 
"DREAM", "DRESS", "DRINK", "EAGLE", "EARTH", "FLAME", "FLUTE", "GHOST", "GLOBE", "GLOVE", 
"GRAPE", "GREEN", "HOTEL", "HOUSE", "JEWEL", "KNIFE", "LEMON", "LIGHT", "MAGIC", "MEDAL", 
"MONEY", "MOUSE", "MUSIC", "OCEAN", "PAINT", "PAPER", "PHONE", "PIANO", "PLANT", "PLATE", 
"QUEEN", "RIVER", "ROBOT", "SNAKE", "SPACE", "SPOON", "STORM", "TIGER", "WATER",
                
                // 25 six-letter words
                "BANANA", "BUTTON", "CAMERA", "COFFEE", "DRAGON", "FOREST", "GARDEN", "GUITAR", "ISLAND", "JACKET", 
                "LADDER", "MARKET", "MONKEY", "ORANGE", "PENCIL", "POCKET", "ROCKET", "SANDWICH", "SCHOOL", "TICKET", 
                "TURTLE", "VELVET", "WALLET", "WINDOW", "WINTER",
                
                // 25 seven-letter words
                "BANANA", "BUTTON", "CAMERA", "COFFEE", "DRAGON", "FOREST", "GARDEN", "GUITAR", "ISLAND", "JACKET", 
"LADDER", "MARKET", "MONKEY", "ORANGE", "PENCIL", "POCKET", "ROCKET", "SANDWICH", "SCHOOL", "TICKET", 
"TURTLE", "VELVET", "WALLET", "WINDOW", "WINTER"
            ];
            
            // Game constants and variables
            const GAME_TIME = 30;
            let dailyWords = [], currentWordIndex = 0, currentWord = "", currentScrambled = "";
            let score = 0, wordsSolved = 0, timeLeft = GAME_TIME, gameActive = false;
            let today, timer;
            
            // Streak and combo system
            let streak = 0, currentStreak = 0, comboMultiplier = 1;
            let lastSolveTime = 0;
            
            // New variables for leaderboard functionality
            let playerInitials = "";
            let dailyLeaderboard = [];
            const MAX_LEADERBOARD_ENTRIES = 3;

            // Cache DOM elements
            const elements = {
                startScreen: document.getElementById("start-screen"),
                playedToday: document.getElementById("played-today"),
                gamePlay: document.getElementById("game-play"),
                gameOver: document.getElementById("game-over"),
                startButton: document.getElementById("start-game"),
                scrambledWord: document.getElementById("scrambled-word"),
                userGuess: document.getElementById("user-guess"),
                submitBtn: document.getElementById("submit-btn"),
                skipBtn: document.getElementById("skip-btn"),
                message: document.getElementById("message"),
                score: document.getElementById("score"),
                timer: document.getElementById("timer"),
                timerProgress: document.getElementById("timer-progress"),
                wordsSolved: document.getElementById("words-solved"),
                countdown: document.getElementById("countdown"),
                countdownEnd: document.getElementById("countdown-end"),
                todayScore: document.getElementById("today-score"),
                dailyDate: document.getElementById("daily-date"),
                shareLink: document.getElementById("share-link"),
                shareLinkPlayed: document.getElementById("share-link-played"),
                twitterShare: document.getElementById("twitter-share"),
                twitterSharePlayed: document.getElementById("twitter-share-played"),
                streakDisplay: document.getElementById("streak-display"),
                currentStreakDisplay: document.getElementById("current-streak-display"),
                gameOverStreakDisplay: document.getElementById("game-over-streak-display"),
                playerInitialsInput: document.getElementById("player-initials"),
                leaderboardEntries: document.getElementById("leaderboard-entries"),
                gameOverLeaderboardEntries: document.getElementById("game-over-leaderboard-entries"),
		playedTodayLeaderboardEntries: document.getElementById("played-today-leaderboard-entries"),
                comboDisplay: document.getElementById("combo-display")
            };

            // Helper functions
            function getCurrentDateCT() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getTimeUntilMidnightLocal() {
                const now = new Date();
                const midnight = new Date(now);
                midnight.setHours(24, 0, 0, 0);
                return midnight - now;
            }

            function updateCountdown() {
                const msLeft = getTimeUntilMidnightLocal();
                const hoursLeft = Math.floor(msLeft / (1000 * 60 * 60));
                const minutesLeft = Math.floor((msLeft % (1000 * 60 * 60)) / (1000 * 60));
                const countdownText = `Next game: ${hoursLeft}h ${minutesLeft}m`;
                elements.countdown.textContent = countdownText;
                elements.countdownEnd.textContent = countdownText;
                if (msLeft <= 0) window.location.reload();
            }

            function seededRandom(seed) {
                let t = seed + 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
            
            // Firebase Leaderboard functions
            function getLeaderboardRef() {
                const dateKey = getCurrentDateCT().split("?")[0].replace(/-/g, "");
                return ref(firebaseDB, `leaderboards/${dateKey}`);
            }
            
            function loadLeaderboard() {
                const leaderboardRef = getLeaderboardRef();
                
                // Set up real-time listener for leaderboard updates
                onValue(leaderboardRef, (snapshot) => {
                    // Get data from Firebase
                    const data = snapshot.val();
                    
                    // Convert object to array for easier sorting
                    dailyLeaderboard = [];
                    if (data) {
                        Object.keys(data).forEach(key => {
                            dailyLeaderboard.push({
                                id: key,
                                initials: data[key].initials,
                                score: data[key].score,
                                wordsSolved: data[key].wordsSolved,
                                timestamp: data[key].timestamp
                            });
                        });
                    }
                    
                    // Sort the leaderboard by score (highest first)
                    dailyLeaderboard.sort((a, b) => b.score - a.score);
                    
                    // Update all leaderboard displays
                    updateLeaderboardDisplay(elements.leaderboardEntries);
                    updateLeaderboardDisplay(elements.gameOverLeaderboardEntries);
                    updateLeaderboardDisplay(elements.playedTodayLeaderboardEntries);
                });
            }
            
            function saveLeaderboard() {
                // No need to modify localStorage logic as we'll keep it for backup
                // and in case Firebase is unavailable
                try {
                    const today = getCurrentDateCT().split("?")[0];
                    localStorage.setItem(`leaderboard_${today}`, JSON.stringify(dailyLeaderboard));
                } catch (error) {
                    console.error("Error saving local leaderboard:", error);
                }
            }
            
            function addScoreToLeaderboard(initials, playerScore, timestamp) {
                if (!initials || initials.trim() === "") {
                    initials = "???";
                } else {
                    initials = initials.trim().toUpperCase().substring(0, 3);
                }
                
                playerInitials = initials;
                
                // Save score to Firebase
                const leaderboardRef = getLeaderboardRef();
                const newScoreRef = push(leaderboardRef);
                
                set(newScoreRef, {
                    initials: initials,
                    score: playerScore,
                    wordsSolved: wordsSolved,
                    timestamp: timestamp
                })
                .then(() => {
                    console.log("Score saved to Firebase successfully");
                })
                .catch((error) => {
                    console.error("Error saving score to Firebase:", error);
                    
                    // Fallback to localStorage if Firebase save fails
                    dailyLeaderboard.push({
                        initials: initials,
                        score: playerScore,
                        wordsSolved: wordsSolved,
                        timestamp: timestamp
                    });
                    
                    saveLeaderboard();
                });
            }
            
            function updateLeaderboardDisplay(containerElement) {
                if (!containerElement) return; // Skip if container element doesn't exist
                
                if (dailyLeaderboard.length === 0) {
                    containerElement.innerHTML = `<div class="leaderboard-empty">Be the first to rank!</div>`;
                    return;
                }
                
                containerElement.innerHTML = "";
                
                // Display top entries
                const displayCount = Math.min(dailyLeaderboard.length, MAX_LEADERBOARD_ENTRIES);
                for (let i = 0; i < displayCount; i++) {
                    const entry = dailyLeaderboard[i];
                    const isCurrentPlayer = entry.initials === playerInitials && 
                                           entry.score === score && 
                                           entry.timestamp === lastSolveTime;
                    
                    const entryDiv = document.createElement("div");
                    entryDiv.className = `leaderboard-entry ${isCurrentPlayer ? "highlight" : ""}`;
                    entryDiv.innerHTML = `
                        <span><span class="rank">${i + 1}.</span> <span class="initials">${entry.initials}</span></span>
                        <span class="score">${entry.score} pts</span>
                    `;
                    containerElement.appendChild(entryDiv);
                }
            }

            // Game functions
            function getDailyWords(dateStr) {
                let seed = 0;
                for (let i = 0; i < dateStr.length; i++) seed += dateStr.charCodeAt(i);
                
                const shuffledWords = [...allWords];
                
                for (let i = shuffledWords.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom(seed + i) * (i + 1));
                    [shuffledWords[i], shuffledWords[j]] = [shuffledWords[j], shuffledWords[i]];
                }
                return shuffledWords.slice(0, 30);
            }

            function scrambleWord(word, dateStr, wordIndex) {
                const wordArray = word.split("");
                let seed = 0;
                for (let i = 0; i < dateStr.length; i++) seed += dateStr.charCodeAt(i);
                seed += wordIndex * 100;

                for (let i = wordArray.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom(seed + i) * (i + 1));
                    [wordArray[i], wordArray[j]] = [wordArray[j], wordArray[i]];
                }

                let scrambled = wordArray.join("");
                if (scrambled === word && wordArray.length >= 2) {
                    [wordArray[0], wordArray[1]] = [wordArray[1], wordArray[0]];
                    scrambled = wordArray.join("");
                }
                return scrambled;
            }

            function hasPlayedToday() {
                try {
                    const playedDate = localStorage.getItem('lastPlayedDate');
                    if (!playedDate) return false;
                    const playedDateClean = playedDate.split("?")[0];
                    const todayClean = today.split("?")[0];
                    return playedDateClean === todayClean;
                } catch (error) {
                    console.error("Local storage error:", error);
                    return false;
                }
            }

            function saveToday(finalScore) {
                try {
                    localStorage.setItem('lastPlayedDate', today);
                    localStorage.setItem('lastScore', finalScore);
                    localStorage.setItem('wordsSolved', wordsSolved);
                    localStorage.setItem('lastInitials', playerInitials);
                    
                    // Save streak
                    if (finalScore > 0) {
                        streak = (parseInt(localStorage.getItem('streak') || '0')) + 1;
                        localStorage.setItem('streak', streak);
                    } else {
                        streak = 0;
                        localStorage.setItem('streak', 0);
                    }
                } catch (error) {
                    console.error("Local storage error:", error);
                }
            }

            function getNextWord() {
                if (currentWordIndex >= dailyWords.length) currentWordIndex = 0;
                currentWord = dailyWords[currentWordIndex];
                currentScrambled = scrambleWord(currentWord, today.split("?")[0], currentWordIndex);
                elements.scrambledWord.textContent = currentScrambled;
                
                // Add animation class for new word appearance
                elements.scrambledWord.classList.add('new-word');
                setTimeout(() => {
                    elements.scrambledWord.classList.remove('new-word');
                }, 600);
                
                elements.userGuess.value = "";
                elements.message.textContent = "";
                elements.message.className = "";
                elements.userGuess.focus();
            }

            function checkAnswer() {
                if (!gameActive) return;
                const userGuess = elements.userGuess.value.trim().toUpperCase();

                if (userGuess === currentWord) {
                    updateWordStats(currentWord, true);
                    elements.message.textContent = "Correct!";
                    elements.message.className = "correct";
                    
                    // Calculate points with combo system
                    const timeSinceLastSolve = lastSolveTime > 0 ? Date.now() - lastSolveTime : 0;
                    lastSolveTime = Date.now();
                    
                    // Quick consecutive solves increase combo multiplier
                    if (timeSinceLastSolve > 0 && timeSinceLastSolve < 5000) { // 5 seconds
                        currentStreak++;
                        if (currentStreak >= 3) {
                            comboMultiplier = Math.min(3, 1 + Math.floor(currentStreak / 3)); // Max 3x multiplier
                            
                            // Show combo message
                            elements.comboDisplay.textContent = `${comboMultiplier}x COMBO!`;
                            elements.comboDisplay.classList.add('active');
                            setTimeout(() => {
                                elements.comboDisplay.classList.remove('active');
                            }, 2000);
                        }
                    } else {
                        currentStreak = 1;
                        comboMultiplier = 1;
                    }
                    
                    const basePoints = currentWord.length * 10;
                    const points = basePoints * comboMultiplier;
                    
                    score += points;
                    wordsSolved++;
                    elements.score.textContent = score;
                    elements.wordsSolved.textContent = wordsSolved;
                    elements.userGuess.value = "";
                    currentWordIndex++;
                    
                    getNextWord();
                } else if (userGuess !== "") {
                    elements.message.textContent = "Try again!";
                    elements.message.className = "incorrect";
                    currentStreak = 0;
                    comboMultiplier = 1;
                }
            }

            function skipWord() {
                if (!gameActive) return;
                updateWordStats(currentWord, false);
                elements.userGuess.value = "";
                currentWordIndex++;
                currentStreak = 0;
                comboMultiplier = 1;
                getNextWord();
            }

            function updateTimer() {
                // Update text
                elements.timer.textContent = `Time: ${timeLeft}s`;
                
                // Update progress bar
                const percentage = (timeLeft / GAME_TIME) * 100;
                elements.timerProgress.style.width = `${percentage}%`;
                
                // Add pulse animation when time is low
                if (timeLeft <= 5) {
                    elements.timer.classList.add('low');
                } else {
                    elements.timer.classList.remove('low');
                }
            }

            function setupShareLink(elementId) {
                const gameLink = window.location.href;
                const currentDate = new Date();
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                const formattedDate = currentDate.toLocaleDateString('en-US', options);
                const displayScore = elementId === "share-link" ? score : (localStorage.getItem('lastScore') || "0");
                const shareMessage = `Scrambl ${formattedDate}: ${displayScore} points. ${gameLink}`;
                
                // SMS share
                document.getElementById(elementId).href = `sms:?&body=${encodeURIComponent(shareMessage)}`;
                
                // Twitter share
                const twitterId = elementId === "share-link" ? "twitter-share" : "twitter-share-played";
                document.getElementById(twitterId).href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareMessage)}`;
            }

            function updateStreakDisplay() {
                try {
                    const currentStreak = parseInt(localStorage.getItem('streak') || '0');
                    if (currentStreak > 0) {
                        elements.streakDisplay.textContent = `${currentStreak} day streak ðŸ”¥`;
                        elements.currentStreakDisplay.textContent = `${currentStreak} day streak ðŸ”¥`;
                        elements.gameOverStreakDisplay.textContent = `${currentStreak} day streak ðŸ”¥`;
                    } else {
                        elements.streakDisplay.textContent = '';
                        elements.currentStreakDisplay.textContent = '';
                        elements.gameOverStreakDisplay.textContent = '';
                    }
                } catch (error) {
                    console.error("Streak display error:", error);
                }
            }

            function endGame() {
                gameActive = false;
                cancelAnimationFrame(timer);
                document.getElementById("final-score-display").textContent = `${wordsSolved} words | ${score} points`;
                
                setupShareLink("share-link");

                // Track game completed
                analytics.trackGameCompleted(score, wordsSolved, 'normal');
                
                // Save score to Firebase and local storage
                saveToday(score);
                
                // Add to leaderboard (which will handle adding to Firebase)
                addScoreToLeaderboard(playerInitials, score, Date.now());
                
                elements.gamePlay.style.display = "none";
                elements.gameOver.style.display = "block";
                updateCountdown();
                updateStreakDisplay();
                setInterval(updateCountdown, 60000);
            }
            
            function animateTimer() {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                
                if (elapsed >= 1) {
                    timeLeft--;
                    updateTimer();
                    startTime = now;
                    
                    if (timeLeft <= 0) {
                        endGame();
                        return;
                    }
                }
                
                if (gameActive) {
                    timer = requestAnimationFrame(animateTimer);
                }
            }
            
            let startTime;
            
            function startGame() {
                if (hasPlayedToday()) return;
                
                // Get player initials
                playerInitials = elements.playerInitialsInput.value.trim().toUpperCase().substring(0, 3);
                localStorage.setItem('lastInitials', playerInitials);
                
                // Reset game variables
                currentWordIndex = 0;
                score = 0;
                wordsSolved = 0;
                timeLeft = GAME_TIME;
                gameActive = true;
                currentStreak = 0;
                comboMultiplier = 1;
                lastSolveTime = Date.now();

                elements.score.textContent = score;
                elements.wordsSolved.textContent = wordsSolved;
                updateTimer();

                elements.startScreen.style.display = "none";
                elements.gamePlay.style.display = "block";
                elements.gameOver.style.display = "none";

                getNextWord();
                
                // Use requestAnimationFrame for better performance
                startTime = Date.now();
                timer = requestAnimationFrame(animateTimer);
            }

            function initGame() {
                const timestamp = new Date().getTime();
                today = getCurrentDateCT() + "?t=" + timestamp;
                
                const now = new Date();
                const options = { weekday: 'long', month: 'short', day: 'numeric' };
                elements.dailyDate.textContent = now.toLocaleDateString('en-US', options);

                const lastPlayedDate = localStorage.getItem('lastPlayedDate');
                if (lastPlayedDate && lastPlayedDate.split("?")[0] !== today.split("?")[0]) {
                    localStorage.removeItem('lastPlayedDate');
                    localStorage.removeItem('lastScore');
                    localStorage.removeItem('wordsSolved');
                    // Don't remove lastInitials so we can remember the player
                }
                
                dailyWords = getDailyWords(today.split("?")[0]);
                
                // Update streak display
                updateStreakDisplay();
                
                // Load leaderboard from Firebase
                loadLeaderboard();
                
                // Set previous initials if available
                const lastInitials = localStorage.getItem('lastInitials');
                if (lastInitials) {
                    elements.playerInitialsInput.value = lastInitials;
                    playerInitials = lastInitials;
                }
                
                // Track page view
                analytics.trackPageView();

                if (hasPlayedToday()) {
                    try {
                        const lastScore = localStorage.getItem('lastScore') || "0";
                        const lastWordsSolved = localStorage.getItem('wordsSolved') || "0";
                        elements.todayScore.textContent = `${lastWordsSolved} words | ${lastScore} points`;
                        
                        setupShareLink("share-link-played");
                    } catch (error) {
                        console.error("Local storage error:", error);
                    }

                    elements.startScreen.style.display = "none";
                    elements.playedToday.style.display = "block";
                    updateCountdown();
                    setInterval(updateCountdown, 60000);
                } else {
                    elements.startScreen.style.display = "block";
                    elements.playedToday.style.display = "none";
                }

                // Load word stats
                getMostStats();
            }

            // Event listeners
            elements.startButton.addEventListener("click", startGame);
            elements.submitBtn.addEventListener("click", checkAnswer);
            elements.skipBtn.addEventListener("click", skipWord);
            
            // Add event listener for the initials input to enforce uppercase
            elements.playerInitialsInput.addEventListener("input", function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            });
            
            // Share button tracking
            elements.shareLink.addEventListener("click", function() {
                analytics.trackShare("game_completed", score, "sms");
            });
            
            elements.shareLinkPlayed.addEventListener("click", function() {
                const lastScore = localStorage.getItem('lastScore') || "0";
                analytics.trackShare("already_played", parseInt(lastScore), "sms");
            });
            
            elements.twitterShare.addEventListener("click", function() {
                analytics.trackShare("game_completed", score, "twitter");
            });
            
            elements.twitterSharePlayed.addEventListener("click", function() {
                const lastScore = localStorage.getItem('lastScore') || "0";
                analytics.trackShare("already_played", parseInt(lastScore), "twitter");
            });

            elements.userGuess.addEventListener("keypress", (e) => {
                if (e.key === "Enter") checkAnswer();
            });
            
            // Add keyboard shortcuts for better accessibility
            document.addEventListener("keydown", (e) => {
                if (!gameActive) return;
                
                // Escape key to skip word
                if (e.key === "Escape") {
                    skipWord();
                }
            });

            // Initialize game on page load
            window.addEventListener("DOMContentLoaded", initGame);
            
            // Add these functions after your existing Firebase functions
            function updateWordStats(word, isSolved) {
                const dateKey = getCurrentDateCT().split("?")[0].replace(/-/g, "");
                const statsRef = ref(firebaseDB, `wordStats/${dateKey}/${word}`);
                
                // Get current stats
                get(statsRef).then((snapshot) => {
                    const data = snapshot.val() || { solved: 0, skipped: 0 };
                    if (isSolved) {
                        data.solved = (data.solved || 0) + 1;
                    } else {
                        data.skipped = (data.skipped || 0) + 1;
                    }
                    // Update stats
                    return set(statsRef, data);
                }).catch((error) => {
                    console.error("Error updating word stats:", error);
                });
            }
            
            function getMostStats() {
                const dateKey = getCurrentDateCT().split("?")[0].replace(/-/g, "");
                const statsRef = ref(firebaseDB, `wordStats/${dateKey}`);
                
                // Set up real-time listener for stats
                onValue(statsRef, (snapshot) => {
                    const stats = snapshot.val() || {};
                    let mostSolved = { word: '-', count: 0 };
                    let mostSkipped = { word: '-', count: 0 };
                    
                    Object.entries(stats).forEach(([word, data]) => {
                        if (data.solved > mostSolved.count) {
                            mostSolved = { word, count: data.solved };
                        }
                        if (data.skipped > mostSkipped.count) {
                            mostSkipped = { word, count: data.skipped };
                        }
                    });
                    
                    // Update both game over and played today displays
                    document.getElementById('most-solved-word').textContent = mostSolved.word;
                    document.getElementById('most-skipped-word').textContent = mostSkipped.word;
                    document.getElementById('most-solved-word-played').textContent = mostSolved.word;
                    document.getElementById('most-skipped-word-played').textContent = mostSkipped.word;
                }, (error) => {
                    console.error("Error getting word stats:", error);
                });
            }

            // Public API
            return {
                start: startGame
            };
        })();
    </script>
</body>
</html>
