<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrambl</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .game-container {
            background-color: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #e0e0e0;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        .scrambled-word {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
            color: #4fc3f7;
            letter-spacing: 3px;
        }
        input {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #444;
            border-radius: 5px;
            width: 60%;
            margin-right: 10px;
            background-color: #3d3d3d;
            color: #f0f0f0;
        }
        button {
            padding: 10px 15px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0d8bf2;
        }
        .buttons {
            margin: 20px 0;
        }
        #message {
            margin: 20px 0;
            font-weight: bold;
            min-height: 24px;
        }
        #message.correct {
            color: #4caf50;
        }
        #message.incorrect {
            color: #f44336;
        }
        .score {
            margin-top: 20px;
            font-weight: bold;
        }
        .timer {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #f44336;
        }
        .game-over {
            display: none;
            font-size: 1.5em;
            color: #e0e0e0;
            margin: 20px 0;
        }
        .final-score {
            font-size: 1.5em;
            color: #4caf50;
            margin: 20px 0;
        }
        #start-game {
            background-color: #4caf50;
            font-size: 1.2em;
            padding: 15px 30px;
        }
        #start-game:hover {
            background-color: #3d9a40;
        }
        .game-play {
            display: none;
        }
        .start-screen {
            padding: 20px;
        }
        .played-today {
            display: none;
            padding: 20px;
        }
        .countdown {
            font-size: 1.2em;
            color: #f44336;
            margin: 20px 0;
        }
        .daily-date {
            font-size: 1.2em;
            color: #4fc3f7;
            margin-bottom: 20px;
        }
        .score-display {
            margin: 15px 0;
            font-size: 1.2em;
            font-weight: bold;
            color: #4fc3f7;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Scrambl</h1>
        <div class="daily-date" id="daily-date"></div>

        <div class="start-screen" id="start-screen">
            <p>A new scrambl every day</p>
            <p>solve the most words in 30 seconds</p>
            <p>10 points for each letter in a word</p>
            <p>share your score - leaderboard soon</p>
            <button id="start-game">Play</button>
        </div>

        <div class="played-today" id="played-today">
            <p>Already played today.</p>
            <div class="final-score">Score: <span id="today-score">0</span></div>
            <div class="countdown" id="countdown"></div>
            <div class="share-score" style="margin: 20px 0;">
                <a id="share-link-played" href="#" target="_blank" style="display: inline-block; background-color: #4caf50; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; margin-top: 10px;">
                    <span style="font-size: 1.1em;">Share</span>
                </a>
            </div>
        </div>

        <div class="game-play" id="game-play">
            <div class="timer" id="timer">Time: 30s</div>

            <div class="score-display">
                <div>Words solved: <span id="words-solved">0</span> | Score: <span id="score">0</span></div>
            </div>

            <div class="scrambled-word" id="scrambled-word">RDOW</div>

            <div>
                <input type="text" id="user-guess" placeholder="Enter your answer" autocomplete="off">
                <button id="submit-btn">Submit</button>
            </div>

            <div class="buttons">
                <button id="skip-btn">Skip</button>
            </div>

            <div id="message"></div>
        </div>

        <div class="game-over" id="game-over">
            <p>Game Over</p>
            <div class="final-score" id="final-score-display"></div>
            <div class="share-score" style="margin: 20px 0;">
                <a id="share-link" href="#" target="_blank" style="display: inline-block; background-color: #4caf50; color: white; padding: 10px 15px; border-radius: 5px; text-decoration: none; margin-top: 10px;">
                    <span style="font-size: 1.1em;">Share</span>
                </a>
            </div>
            <div class="countdown" id="countdown-end"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Force update the displayed date immediately
            const dailyDateElement = document.getElementById("daily-date");
            const now = new Date();
            
            // Clear any cache - add random parameter
            now.setTime(Date.now()); // Force current time
            
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('en-US', options);
            dailyDateElement.textContent = formattedDate;
            
            // Log the date for debugging
            console.log("Date displayed:", formattedDate);
            console.log("Raw date object:", now);
        });
        // Word list - 200 words (easier, more common words)
        const allWords = [
            // 50 three-letter words
            "CAT", "DOG", "PEN", "CUP", "HAT", 
            "SUN", "RUN", "FUN", "CAR", "BOX", 
            "DAY", "BED", "TOY", "BIG", "RED", 
            "ONE", "TWO", "MAP", "JAM", "EGG", 
            "BUS", "ANT", "APE", "ICE", "KEY", 
            "MOM", "DAD", "TOP", "CAN", "LOG", 
            "BAG", "PIG", "COW", "FOX", "OWL", 
            "RAT", "BAT", "JUG", "ZIP", "NET", 
            "MUD", "TUB", "PAW", "PIN", "JAR", 
            "FAN", "TIE", "POT", "LID", "JOB",

            // 50 four-letter words
            "CAKE", "MILK", "BLUE", "BOOK", "FROG", 
            "DUCK", "HAND", "FISH", "COIN", "BALL", 
            "KITE", "SOAP", "ROAD", "BOAT", "DOOR", 
            "LEAF", "GAME", "STAR", "LAMP", "SOCK", 
            "BELT", "BIRD", "FOOD", "MOON", "RAIN", 
            "WIND", "SEED", "DIRT", "HELP", "JUMP", 
            "RICE", "SAND", "SWIM", "BABY", "TOYS", 
            "BOWL", "RING", "BUGS", "HOME", "FLAG", 
            "CAVE", "HILL", "LADY", "LOCK", "CORN", 
            "SONG", "PLAY", "HERO", "PARK", "TIME",

            // 50 five-letter words
            "APPLE", "BREAD", "CHAIR", "DRINK", "HAPPY", 
            "FLAME", "GRASS", "HOUSE", "PHOTO", "JUICE", 
            "CANDY", "LEMON", "MOUSE", "PAPER", "OCEAN", 
            "PHONE", "QUEEN", "RADIO", "SMILE", "TABLE", 
            "UNCLE", "VIDEO", "WATER", "SUNNY", "ZEBRA", 
            "BEACH", "CLOUD", "DANCE", "EARLY", "FRUIT", 
            "GREEN", "HONEY", "HORSE", "JELLY", "MONEY", 
            "LIGHT", "MOVIE", "PUPPY", "PIZZA", "PLANT", 
            "QUIET", "ROCKS", "SLEEP", "TRUCK", "TIGER", 
            "TRAIN", "WHALE", "WATCH", "SILLY", "LUCKY",

            // 25 six-letter words
            "ANIMAL", "BASKET", "COOKIE", "DINNER", "FAMILY", 
            "FLOWER", "GUITAR", "HAMMER", "MONKEY", "JACKET", 
            "KITTEN", "LITTLE", "MARKET", "FATHER", "ORANGE", 
            "PEANUT", "ROCKET", "SISTER", "TIGERS", "TURTLE", 
            "WINDOW", "YELLOW", "ZIPPER", "BUTTER", "COFFEE",

            // 25 easier, common longer words
            "BALLOON", "COMPUTER", "ELEPHANT", "DINOSAUR", "PLAYGROUND", 
            "FOOTBALL", "SNOWBALL", "POPCORN", "BASEBALL", "RAINCOAT", 
            "BIRTHDAY", "PANCAKES", "SANDWICH", "SUNSHINE", "SWIMMING", 
            "CHOCOLATE", "LOLLIPOP", "SUPERMAN", "PRINCESS", "MOUNTAIN", 
            "THURSDAY", "FAVORITE", "TEACHER", "BATHROOM", "BEDROOM"
        ];

        // Game settings
        const GAME_TIME = 30; // Game time in seconds

        // Game variables
        let dailyWords = [];
        let currentWordIndex = 0;
        let currentWord = "";
        let currentScrambled = "";
        let score = 0;
        let wordsSolved = 0;
        let timeLeft = GAME_TIME;
        let timer;
        let gameActive = false;
        let today;
        let nextReset;

        // Elements
        const startScreen = document.getElementById("start-screen");
        const playedToday = document.getElementById("played-today");
        const gamePlay = document.getElementById("game-play");
        const gameOver = document.getElementById("game-over");
        const startButton = document.getElementById("start-game");
        const scrambledWordElement = document.getElementById("scrambled-word");
        const userGuessInput = document.getElementById("user-guess");
        const submitButton = document.getElementById("submit-btn");
        const skipButton = document.getElementById("skip-btn");
        const messageElement = document.getElementById("message");
        const scoreElement = document.getElementById("score");
        const timerElement = document.getElementById("timer");
        const wordsSolvedElement = document.getElementById("words-solved");
        const countdownElement = document.getElementById("countdown");
        const countdownEndElement = document.getElementById("countdown-end");
        const todayScoreElement = document.getElementById("today-score");
        const dailyDateElement = document.getElementById("daily-date");

        // Function to get current date string (YYYY-MM-DD format)
        function getCurrentDateCT() {
            // Get the current date - using Date.now() to ensure we get the current time
            const now = new Date();
            
            // Format as YYYY-MM-DD ensuring we get today's actual date
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(now.getDate()).padStart(2, '0');
            
            const dateStr = `${year}-${month}-${day}`;
            
            console.log("Generated date:", dateStr, "Raw date object:", now);
            return dateStr;
        }

        // Function to format current date for display
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to get time until midnight local time
        function getTimeUntilMidnightLocal() {
            const now = new Date();
            
            // Set the next midnight in local time
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            
            // Get milliseconds until midnight
            return midnight - now;
        }

        // Function to update countdown timer
        function updateCountdown() {
            const msLeft = getTimeUntilMidnightLocal();
            const hoursLeft = Math.floor(msLeft / (1000 * 60 * 60));
            const minutesLeft = Math.floor((msLeft % (1000 * 60 * 60)) / (1000 * 60));

            const countdownText = `Next: ${hoursLeft}h ${minutesLeft}m`;
            countdownElement.textContent = countdownText;
            countdownEndElement.textContent = countdownText;

            // Check if we've passed midnight and should refresh
            if (msLeft <= 0) {
                window.location.reload();
            }
        }

        // Function to seed the random number generator - improved version
        function seededRandom(seed) {
            // This is a more reliable seeded random implementation
            let t = seed + 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }

        // Function to get daily words using seeded random
        function getDailyWords(dateStr) {
            // Create a seed from the date string
            let seed = 0;
            for (let i = 0; i < dateStr.length; i++) {
                seed += dateStr.charCodeAt(i);
            }
            
            console.log("Using seed:", seed, "for date:", dateStr);

            // Make a copy of all words to shuffle
            const shuffledWords = [...allWords];

            // Fisher-Yates shuffle with seeded random
            for (let i = shuffledWords.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [shuffledWords[i], shuffledWords[j]] = [shuffledWords[j], shuffledWords[i]];
            }

            // Return first 30 words in shuffled order
            return shuffledWords.slice(0, 30);
        }

        // Function to scramble a word
        function scrambleWord(word, dateStr, wordIndex) {
            const wordArray = word.split("");

            // Create a deterministic seed based on date and word
            let seed = 0;
            for (let i = 0; i < dateStr.length; i++) {
                seed += dateStr.charCodeAt(i);
            }
            seed += wordIndex * 100; // Add word index to make each word's scramble different

            // Fisher-Yates shuffle with seeded random
            for (let i = wordArray.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [wordArray[i], wordArray[j]] = [wordArray[j], wordArray[i]];
            }

            // Make sure the scrambled word is different from the original
            let scrambled = wordArray.join("");
            if (scrambled === word) {
                // If same, swap first two letters
                if (wordArray.length >= 2) {
                    [wordArray[0], wordArray[1]] = [wordArray[1], wordArray[0]];
                    scrambled = wordArray.join("");
                }
            }

            return scrambled;
        }

        // Function to check if the user has played today
        function hasPlayedToday() {
            try {
                const playedDate = localStorage.getItem('lastPlayedDate');
                // Compare only the date part, not any cache-busting parameters
                if (!playedDate) return false;
                const playedDateClean = playedDate.split("?")[0];
                const todayClean = today.split("?")[0];
                console.log("Comparing dates:", playedDateClean, todayClean);
                return playedDateClean === todayClean;
            } catch (error) {
                console.error("Local storage error:", error);
                return false; // If there's an error, allow play
            }
        }

        // Function to save today's play
        function saveToday(finalScore) {
            try {
                localStorage.setItem('lastPlayedDate', today);
                localStorage.setItem('lastScore', finalScore);
                localStorage.setItem('wordsSolved', wordsSolved);
            } catch (error) {
                console.error("Local storage error:", error);
                // Handle the error silently - game will still work but progress won't be saved
            }
        }

        // Function to get points for a word based on length
        function getPointsForWord(word) {
            const length = word.length;
            return length * 10; // 10 points per letter
        }
        
        // Function to get the next word
        function getNextWord() {
            if (currentWordIndex >= dailyWords.length) {
                currentWordIndex = 0; // Wrap around if we've gone through all words
            }

            currentWord = dailyWords[currentWordIndex];
            currentScrambled = scrambleWord(currentWord, today, currentWordIndex);

            // Update UI
            scrambledWordElement.textContent = currentScrambled;
            userGuessInput.value = "";
            messageElement.textContent = "";
            messageElement.className = "";
            
            // Focus on input
            userGuessInput.focus();
        }

        // Function to check answer
        function checkAnswer() {
            if (!gameActive) return;

            const userGuess = userGuessInput.value.trim().toUpperCase();

            if (userGuess === currentWord) {
                // Correct answer
                messageElement.textContent = "Correct!";
                messageElement.className = "correct";
                
                // Add points based on word length
                const points = getPointsForWord(currentWord);
                score += points;
                
                wordsSolved++;
                scoreElement.textContent = score;
                wordsSolvedElement.textContent = wordsSolved;
                userGuessInput.value = ""; // Clear the input field
                currentWordIndex++;
                getNextWord();
            } else if (userGuess !== "") {
                // Incorrect answer
                messageElement.textContent = "Try again!";
                messageElement.className = "incorrect";
            }
        }

        // Function to skip current word
        function skipWord() {
            if (!gameActive) return;
            userGuessInput.value = ""; // Clear the input field
            currentWordIndex++;
            getNextWord();
        }

        // Function to update timer display
        function updateTimer() {
            timerElement.textContent = `Time: ${timeLeft}s`;
        }

        // Function to end the game
        function endGame() {
            gameActive = false;
            clearInterval(timer);

            // Update final score display
            document.getElementById("final-score-display").textContent = `${wordsSolved} words | ${score} points`;

            // Update share link
            const gameLink = window.location.href;
            const shareMessage = `Scrambl ${formatDateForDisplay(today)}: ${score} points. ${gameLink}`;
            document.getElementById("share-link").href = `sms:?&body=${encodeURIComponent(shareMessage)}`;
            document.getElementById("share-link-played").href = `sms:?&body=${encodeURIComponent(shareMessage)}`;

            // Save today's play
            saveToday(score);
            
            // Show game over screen
            gamePlay.style.display = "none";
            gameOver.style.display = "block";

            // Start countdown timer
            updateCountdown();
            setInterval(updateCountdown, 60000); // Update every minute
        }

        // Function to start the game
        function startGame() {
            if (hasPlayedToday()) {
                return; // Don't allow starting if already played today
            }
            
            // Reset game variables
            currentWordIndex = 0;
            score = 0;
            wordsSolved = 0;
            timeLeft = GAME_TIME;
            gameActive = true;

            // Update UI
            scoreElement.textContent = score;
            wordsSolvedElement.textContent = wordsSolved;
            updateTimer();

            // Hide start screen, show game play
            startScreen.style.display = "none";
            gamePlay.style.display = "block";
            gameOver.style.display = "none";

            // Get first word
            getNextWord();

            // Start timer
            timer = setInterval(() => {
                timeLeft--;
                updateTimer();

                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        // Function to initialize game
        function initGame() {
            // Force getting a fresh date
            const timestamp = new Date().getTime();
            
            // Get today's date string with cache-busting
            today = getCurrentDateCT() + "?t=" + timestamp;
            
            // Set the date display explicitly with cache-busting
            const now = new Date(Date.now()); // Force current time
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('en-US', options);
            dailyDateElement.textContent = formattedDate;
            
            // Explicitly log today's date for debugging
            console.log("Today's actual date for game:", today);
            console.log("Formatted display date:", formattedDate);
            console.log("Raw date object:", now);

            // Clear any cached data from localStorage if the date has changed
            const lastPlayedDate = localStorage.getItem('lastPlayedDate');
            if (lastPlayedDate && lastPlayedDate.split("?")[0] !== today.split("?")[0]) {
                console.log("New day detected! Clearing previous day's data");
                // Force clear localStorage for a new day
                localStorage.removeItem('lastPlayedDate');
                localStorage.removeItem('lastScore');
                localStorage.removeItem('wordsSolved');
            }

            // Get today's words
            dailyWords = getDailyWords(today.split("?")[0]);
            
            // Log the first few words to confirm they are different each day
            console.log("Today's first few words:", dailyWords.slice(0, 5));

            // Check if the user has played today
            if (hasPlayedToday()) {
                try {
                    const lastScore = localStorage.getItem('lastScore') || "0";
                    const lastWordsSolved = localStorage.getItem('wordsSolved') || "0";
                    todayScoreElement.textContent = `${lastWordsSolved} words | ${lastScore} points`;

                    // Update share link
                    const gameLink = window.location.href;
                    const shareMessage = `Scrambl ${formattedDate}: ${lastScore} points. ${gameLink}`;
                    document.getElementById("share-link-played").href = `sms:?&body=${encodeURIComponent(shareMessage)}`;
                } catch (error) {
                    console.error("Local storage error:", error);
                }

                // Show played today screen
                startScreen.style.display = "none";
                playedToday.style.display = "block";

                // Start countdown timer
                updateCountdown();
                setInterval(updateCountdown, 60000); // Update every minute
            } else {
                // Show start screen
                startScreen.style.display = "block";
                playedToday.style.display = "none";
            }
        }

        // Event listeners
        startButton.addEventListener("click", startGame);
        submitButton.addEventListener("click", checkAnswer);
        skipButton.addEventListener("click", skipWord);

        // Enter key to submit
        userGuessInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                checkAnswer();
            }
        });

        // Initialize game on page load
        window.addEventListener("DOMContentLoaded", initGame);
    </script>
</body>
</html>
