/* Leaderboard styles */
.leaderboard {
    margin: 15px 0;
    background: rgba(132, 220, 198, 0.2);
    padding: 10px;
    border-radius: 12px;
    max-width: 320px;
    margin: 15px auto;
}

.leaderboard h3 {
    margin: 0 0 10px 0;
    font-size: 1.2em;
    color: var(--accent-main);
}

.leaderboard-entries {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.leaderboard-entry {
    display: flex;
    justify-content: space-between;
    padding: 4px 8px;
    border-radius: 8px;
    background: rgba(75, 78, 109, 0.5);
    color: var(--text-light);
    font-size: 0.95em;
}

.leaderboard-entry.highlight {
    background: rgba(255, 219, 181, 0.3);
    font-weight: bold;
}

.leaderboard-entry .rank {
    margin-right: 5px;
}

.leaderboard-entry .initials {
    font-weight: bold;
    color: var(--accent-main);
}

.leaderboard-entry .score {
    color: var(--accent-peach);
}

.leaderboard-empty {
    text-align: center;
    padding: 8px;
    color: #aaa;
    font-style: italic;
}

<!-- Leaderboard display -->
<div class="leaderboard" id="leaderboard">
    <h3>today's top scores</h3>
    <div class="leaderboard-entries" id="leaderboard-entries">
        <div class="leaderboard-empty">Play to get on the board</div>
    </div>
</div>

<!-- Streak display -->
<div class="streak-display" id="streak-display"></div>

<!-- Added leaderboard to played-today screen - MOVED ABOVE SHARE BUTTONS -->
<div class="leaderboard" id="played-today-leaderboard">
    <h3>today's top scores</h3>
    <div class="leaderboard-entries" id="played-today-leaderboard-entries">
        <div class="leaderboard-empty">Be the first to rank!</div>
    </div>
</div>

<!-- Share buttons now below leaderboard -->
<div class="share-score">

<!-- Added leaderboard to game over screen - MOVED ABOVE SHARE BUTTONS -->
<div class="leaderboard" id="game-over-leaderboard">
    <h3>today's top scores</h3>
    <div class="leaderboard-entries" id="game-over-leaderboard-entries">
        <div class="leaderboard-empty">Be the first to rank!</div>
    </div>
</div>

<!-- Share buttons now below leaderboard -->
<div class="share-score"> 

const ScramblGame = (function() {
    // Make Firebase services accessible in the game module
    const firebaseDB = database;
    
    // Analytics module
    const analytics = {
        trackPageView: function() {
            gtag('event', 'Scrambl_Page_Visit', {
                'page_title': 'Scrambl Word Game',
                'page_location': window.location.href
            });
        },
        
        trackGameCompleted: function(score, wordsSolved, difficulty) {
            gtag('event', 'Scrambl_Game_Completed', {
                'event_category': 'Game Actions',
                'score': score,
                'words_solved': wordsSolved,
                'difficulty': difficulty
            });
        },
        
        trackShare: function(context, score, platform) {
            gtag('event', 'Scrambl_Score_Shared', {
                'event_category': 'Game Actions',
                'share_context': context,
                'score': score,
                'platform': platform
            });
        },
    };

    // Game constants and variables
    const GAME_TIME = 30;
    let dailyWords = [], currentWordIndex = 0, currentWord = "", currentScrambled = "";
    let score = 0, wordsSolved = 0, timeLeft = GAME_TIME, gameActive = false;
    let today, timer;
    
    // Streak and combo system
    let streak = 0, currentStreak = 0, comboMultiplier = 1;
    let lastSolveTime = 0;
    
    // New variables for leaderboard functionality
    let playerInitials = "";
    let dailyLeaderboard = [];
    const MAX_LEADERBOARD_ENTRIES = 5;

    // Cache DOM elements
    const elements = {
        startScreen: document.getElementById("start-screen"),
        playedToday: document.getElementById("played-today"),
        gamePlay: document.getElementById("game-play"),
        gameOver: document.getElementById("game-over"),
        startButton: document.getElementById("start-game"),
        scrambledWord: document.getElementById("scrambled-word"),
        userGuess: document.getElementById("user-guess"),
        submitBtn: document.getElementById("submit-btn"),
        skipBtn: document.getElementById("skip-btn"),
        message: document.getElementById("message"),
        score: document.getElementById("score"),
        timer: document.getElementById("timer"),
        timerProgress: document.getElementById("timer-progress"),
        wordsSolved: document.getElementById("words-solved"),
        countdown: document.getElementById("countdown"),
        countdownEnd: document.getElementById("countdown-end"),
        todayScore: document.getElementById("today-score"),
        playerInitialsInput: document.getElementById("player-initials"),
        usernameDisplay: document.getElementById("username-display"),
        leaderboardEntries: document.getElementById("leaderboard-entries"),
        gameOverLeaderboardEntries: document.getElementById("game-over-leaderboard-entries"),
        playedTodayLeaderboardEntries: document.getElementById("played-today-leaderboard-entries"),
        shareLink: document.getElementById("share-link"),
        shareLinkPlayed: document.getElementById("share-link-played"),
        twitterShare: document.getElementById("twitter-share"),
        twitterSharePlayed: document.getElementById("twitter-share-played"),
        comboDisplay: document.getElementById("combo-display"),
        dailyDate: document.getElementById("daily-date")
    };

    // Firebase Leaderboard functions
    function getLeaderboardRef() {
        const dateKey = getCurrentDateCT().split("?")[0].replace(/-/g, "");
        return ref(firebaseDB, `leaderboards/${dateKey}`);
    }
    
    function loadLeaderboard() {
        const leaderboardRef = getLeaderboardRef();
        
        // Set up real-time listener for daily leaderboard updates
        onValue(leaderboardRef, (snapshot) => {
            // Get data from Firebase
            const data = snapshot.val();
            
            // Convert object to array for easier sorting
            dailyLeaderboard = [];
            if (data) {
                Object.keys(data).forEach(key => {
                    dailyLeaderboard.push({
                        id: key,
                        username: data[key].username,
                        score: data[key].score,
                        wordsSolved: data[key].wordsSolved,
                        timestamp: data[key].timestamp
                    });
                });
            }
            
            // Sort the leaderboard by score (highest first)
            dailyLeaderboard.sort((a, b) => b.score - a.score);
            
            // Update all daily leaderboard displays
            updateLeaderboardDisplay(elements.leaderboardEntries);
            updateLeaderboardDisplay(elements.gameOverLeaderboardEntries);
            updateLeaderboardDisplay(elements.playedTodayLeaderboardEntries);
        });
    }
    
    function addScoreToLeaderboard(initials, playerScore, timestamp) {
        if (!initials || initials.trim() === "") {
            initials = "Anonymous";
        } else {
            initials = initials.trim();
        }
        
        playerInitials = initials;
        
        // Save score to daily leaderboard
        const leaderboardRef = getLeaderboardRef();
        const newScoreRef = push(leaderboardRef);
        
        set(newScoreRef, {
            username: initials,
            score: playerScore,
            wordsSolved: wordsSolved,
            timestamp: timestamp
        })
        .then(() => {
            console.log("Score saved to daily leaderboard successfully");
        })
        .catch((error) => {
            console.error("Error saving score to Firebase:", error);
            
            // Fallback to localStorage if Firebase save fails
            dailyLeaderboard.push({
                username: initials,
                score: playerScore,
                wordsSolved: wordsSolved,
                timestamp: timestamp
            });
            
            saveLeaderboard();
        });
    }
    
    function updateLeaderboardDisplay(containerElement) {
        if (!containerElement) {
            console.warn('Leaderboard container element missing:', containerElement);
            return; // Skip if container element doesn't exist
        }
        
        if (dailyLeaderboard.length === 0) {
            containerElement.innerHTML = `<div class="leaderboard-empty">Be the first to rank!</div>`;
            return;
        }
        
        containerElement.innerHTML = "";
        
        // Display top entries
        const displayCount = Math.min(dailyLeaderboard.length, MAX_LEADERBOARD_ENTRIES);
        for (let i = 0; i < displayCount; i++) {
            const entry = dailyLeaderboard[i];
            const isCurrentPlayer = entry.username === playerInitials && 
                                 entry.score === score && 
                                 entry.timestamp === lastSolveTime;
            
            const entryDiv = document.createElement("div");
            entryDiv.className = `leaderboard-entry ${isCurrentPlayer ? "highlight" : ""}`;
            
            entryDiv.innerHTML = `
                <span><span class="rank">${i + 1}.</span> <span class="initials">${entry.username}</span></span>
                <span class="score">${entry.score} pts</span>
            `;
            containerElement.appendChild(entryDiv);
        }
    }

    function initGame() {
        const timestamp = new Date().getTime();
        today = getCurrentDateCT() + "?t=" + timestamp;
        
        const now = new Date();
        const options = { weekday: 'long', month: 'short', day: 'numeric' };
        elements.dailyDate.textContent = now.toLocaleDateString('en-US', options);

        const lastPlayedDate = localStorage.getItem('lastPlayedDate');
        if (lastPlayedDate && lastPlayedDate.split("?")[0] !== today.split("?")[0]) {
            localStorage.removeItem('lastPlayedDate');
            localStorage.removeItem('lastScore');
            localStorage.removeItem('wordsSolved');
            // Don't remove lastUsername so we can remember the player
        }
        
        dailyWords = getDailyWords(today.split("?")[0]);
        
        // Update streak display
        updateStreakDisplay();
        
        // Load daily leaderboard from Firebase
        loadLeaderboard();
        
        // Set previous username if available
        const lastUsername = localStorage.getItem('lastUsername');
        if (lastUsername) {
            elements.playerInitialsInput.value = lastUsername;
            playerInitials = lastUsername;
            updateUsernameDisplay(lastUsername);
        }
        
        // Track page view
        analytics.trackPageView();

        if (hasPlayedToday()) {
            try {
                const lastScore = localStorage.getItem('lastScore') || "0";
                const lastWordsSolved = localStorage.getItem('wordsSolved') || "0";
                elements.todayScore.textContent = `${lastWordsSolved} words | ${lastScore} points`;
                
                setupShareLink("share-link-played");
            } catch (error) {
                console.error("Local storage error:", error);
            }

            elements.startScreen.style.display = "none";
            elements.playedToday.style.display = "block";
            updateCountdown();
            setInterval(updateCountdown, 60000);
        } else {
            elements.startScreen.style.display = "block";
            elements.playedToday.style.display = "none";
        }

        // Load word stats
        getMostStats();
    }
})(); 